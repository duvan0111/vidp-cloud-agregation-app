name: Deploy to EC2

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

env:
  APP_DIR: /home/ubuntu/aggregation

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=. --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          AWS_REGION=${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          DYNAMODB_TABLE_NAME=${{ secrets.DYNAMODB_TABLE_NAME }}
          HOST=0.0.0.0
          PORT=8005
          DEBUG=false
          WORKERS=2
          LOG_LEVEL=INFO
          FFMPEG_PRESET=medium
          FFMPEG_CODEC=libx264
          FFMPEG_CRF=23
          FFMPEG_TIMEOUT=600
          API_TITLE=Video Aggregation Service
          API_VERSION=2.0.0
          EOF
      
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "Starting deployment..."
            echo "=========================================="
            
            # Navigate to application directory
            cd ${{ env.APP_DIR }}
            
            # Pull latest code
            echo "Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main
            
            # Activate virtual environment
            source venv/bin/activate
            
            # Install/update dependencies
            echo "Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Run database migrations (si nÃ©cessaire)
            # python manage.py migrate
            
            # Restart the service
            echo "Restarting service..."
            sudo systemctl restart vidp-aggregation
            
            # Wait for service to start
            sleep 5
            
            # Check service status
            if sudo systemctl is-active --quiet vidp-aggregation; then
              echo "âœ… Service started successfully"
            else
              echo "âŒ Service failed to start"
              sudo journalctl -u vidp-aggregation -n 50 --no-pager
              exit 1
            fi
          ENDSSH
      
      - name: Upload .env to EC2
        run: |
          scp -o StrictHostKeyChecking=no .env \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.APP_DIR }}/.env
      
      - name: Configure AWS credentials on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            mkdir -p ~/.aws
            cat > ~/.aws/credentials << EOF
          [default]
          aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          EOF
            
            cat > ~/.aws/config << EOF
          [default]
          region = ${{ secrets.AWS_REGION }}
          output = json
          EOF
            
            chmod 600 ~/.aws/credentials
            chmod 600 ~/.aws/config
          ENDSSH
      
      - name: Health Check
        run: |
          echo "Waiting for service to be ready..."
          sleep 10
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              http://${{ secrets.EC2_HOST }}/api/health || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed!"
              curl -s http://${{ secrets.EC2_HOST }}/api/health | jq .
              exit 0
            else
              echo "â³ Health check failed (attempt $((RETRY_COUNT+1))/$MAX_RETRIES)"
              RETRY_COUNT=$((RETRY_COUNT+1))
              sleep 5
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1
      
      - name: Notify Deployment Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Service URL: http://${{ secrets.EC2_HOST }}"
      
      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo journalctl -u vidp-aggregation -n 100 --no-pager"
